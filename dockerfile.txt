# Use Ubuntu as base image
FROM ubuntu:22.04

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    unzip \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    nodejs \
    npm \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# Install citygml-to-3dtiles globally
RUN npm install -g citygml-to-3dtiles@1.3.0

# Clone tile-converter
RUN git clone https://github.com/Esri/tile-converter.git /opt/tile-converter \
    && cd /opt/tile-converter \
    && npm install

# Download EGM file
RUN mkdir -p /opt/tile-converter/deps \
    && wget -O /opt/tile-converter/deps/egm2008-5.pgm \
       https://github.com/Esri/tile-converter/raw/master/deps/egm2008-5.pgm

# Install 3DCityDB tools (simplified - using pre-built)
RUN wget https://github.com/3dcitydb/importer-exporter/releases/download/v1.1.0/citydb-tool-1.1.0.jar -O /opt/citydb-tool.jar

# Create wrapper script for 3DCityDB
RUN echo '#!/bin/bash\njava -jar /opt/citydb-tool.jar "$@"' > /usr/local/bin/citydb \
    && chmod +x /usr/local/bin/citydb

# Create directories
RUN mkdir -p /app/output /app/logs /app/scripts /app/config

# Copy application files
COPY scripts/ /app/scripts/
COPY config/ /app/config/
COPY entrypoint.sh /app/

# Make scripts executable
RUN chmod +x /app/entrypoint.sh \
    && chmod +x /app/scripts/*.py

# Set environment variables
ENV PATH="/usr/local/bin:${PATH}"
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]